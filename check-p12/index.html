<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiểm Tra Chứng Chỉ P12</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/forge/1.3.1/forge.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --card-bg: rgba(30, 41, 59, 0.8);
            --darker: #0f172a;
            --dark: #1e293b;
            --medium: #334155;
            --light: #f1f5f9;
            --accent: #38b2ac;
            --warning: #ecc94b;
            --danger: #e53e3e;
            --success: #38a169;
            --text: #e2e8f0;
            --text-muted: #94a3b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f172a, #1e293b);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
        }

        .container {
            width: 100%;
            max-width: 480px;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            padding: 20px;
            margin-top: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        header {
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            color: var(--light);
            margin-bottom: 6px;
            font-size: 1.6rem;
            font-weight: 700;
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .upload-section, .result-section, .loading-section {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .loading-section {
            border-color: var(--medium);
        }

        .form-group {
            margin-bottom: 15px;
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--light);
            font-size: 0.9rem;
        }

        .file-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e53e3e;
            border-radius: 8px;
            background: rgba(30, 41, 59, 0.8);
            color: var(--text);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .file-input.has-file {
            border-color: #38a169;
        }

        .file-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(56, 178, 172, 0.1);
        }

        .password-container {
            position: relative;
            width: 100%;
        }

        .password-input {
            width: 100%;
            padding: 10px 40px 10px 12px;
            border: 1px solid #e53e3e;
            border-radius: 8px;
            background: rgba(30, 41, 59, 0.8);
            color: var(--text);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .password-input.has-value {
            border-color: #38a169;
        }

        .password-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(56, 178, 172, 0.1);
        }

        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 1rem;
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .toggle-password:hover {
            color: var(--light);
            background: rgba(255, 255, 255, 0.1);
        }

        .btn {
            display: block;
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--accent), #2d968f);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 8px;
        }

        .btn:hover {
            background: linear-gradient(135deg, #2d968f, var(--accent));
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #475569;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-back {
            background: linear-gradient(135deg, #475569, #374151);
            margin-top: 12px;
        }

        .btn-back:hover {
            background: linear-gradient(135deg, #374151, #475569);
        }

        .result-title {
            font-size: 1.2rem;
            color: var(--light);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            font-weight: 700;
        }

        .cert-info {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .cert-info:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 3px;
            font-size: 0.85rem;
        }

        .info-value {
            color: var(--text);
            font-size: 0.9rem;
            line-height: 1.3;
        }

        .status-active {
            color: var(--success);
            font-weight: 600;
        }

        .status-expired {
            color: var(--danger);
            font-weight: 600;
        }

        .status-warning {
            color: var(--warning);
            font-weight: 600;
        }

        .warning {
            background: rgba(234, 179, 8, 0.1);
            border: 1px solid rgba(234, 179, 8, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            font-size: 0.8rem;
            color: var(--warning);
            line-height: 1.4;
        }

        .link {
            color: var(--accent);
            text-decoration: none;
            font-weight: 600;
        }

        .link:hover {
            text-decoration: underline;
        }

        footer {
            margin-top: 20px;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .loading {
            text-align: center;
            margin: 12px 0;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 35px;
            height: 35px;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(229, 62, 62, 0.1);
            color: #fecaca;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
            font-size: 0.85rem;
            line-height: 1.4;
            border: 1px solid rgba(229, 62, 62, 0.3);
        }

        /* Progress bar styles */
        .progress-container {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin: 15px 0;
            overflow: hidden;
            height: 28px;
            position: relative;
        }

        .progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(135deg, var(--accent), #2d968f);
            border-radius: 8px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            position: relative;
            overflow: hidden;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background-image: linear-gradient(
                -45deg,
                rgba(255, 255, 255, 0.2) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255, 255, 255, 0.2) 50%,
                rgba(255, 255, 255, 0.2) 75%,
                transparent 75%,
                transparent
            );
            background-size: 35px 35px;
            animation: move 2s linear infinite;
        }

        @keyframes move {
            0% {
                background-position: 0 0;
            }
            100% {
                background-position: 35px 35px;
            }
        }

        .loading-steps {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .loading-step {
            text-align: center;
            flex: 1;
            padding: 0 6px;
            position: relative;
        }

        .loading-step.active {
            color: var(--light);
            font-weight: 600;
        }

        .loading-step:not(:last-child)::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 6px;
            background: var(--text-muted);
            border-radius: 50%;
        }

        .loading-step.active:not(:last-child)::after {
            background: var(--accent);
        }

        /* Custom file input styles */
        .file-input-wrapper {
            position: relative;
            display: block;
            width: 100%;
        }

        .file-input-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border: 2px dashed #e53e3e;
            border-radius: 8px;
            background: rgba(30, 41, 59, 0.8);
            color: var(--text);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-height: 80px;
        }

        .file-input-label.has-file {
            border-color: #38a169;
        }

        .file-input-label:hover {
            border-color: var(--accent);
            background: rgba(30, 41, 59, 0.9);
        }

        .file-input-label i {
            font-size: 1.5rem;
            margin-bottom: 8px;
            color: var(--text-muted);
        }

        .file-input-label .file-text {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .file-input-label .file-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        /* Mobile optimizations */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
                border-radius: 12px;
                max-width: 100%;
            }
            
            h1 {
                font-size: 1.4rem;
            }
            
            .subtitle {
                font-size: 0.85rem;
            }
            
            .upload-section, .result-section, .loading-section {
                padding: 15px;
                margin-bottom: 12px;
            }
            
            .btn {
                padding: 10px;
                font-size: 0.95rem;
            }
            
            .result-title {
                font-size: 1.1rem;
            }
            
            .cert-info {
                margin-bottom: 8px;
                padding-bottom: 8px;
            }
            
            .progress-container {
                height: 26px;
            }
            
            .progress-bar {
                font-size: 0.85rem;
            }
            
            .loading-steps {
                font-size: 0.7rem;
            }
        }

        @media (max-width: 350px) {
            .container {
                padding: 12px;
            }
            
            h1 {
                font-size: 1.3rem;
            }
            
            .upload-section, .result-section, .loading-section {
                padding: 12px;
            }
            
            .form-group {
                margin-bottom: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Giao diện kiểm tra chứng chỉ -->
        <div id="checkSection">
            <header>
                <h1>Kiểm Tra Chứng Chỉ P12</h1>
                <p class="subtitle">Kiểm tra thông tin và trạng thái chứng chỉ của bạn</p>
            </header>

            <section class="upload-section">
                <div class="form-group">
                    <label for="p12File">File .p12 hoặc .zip</label>
                    <div class="file-input-wrapper">
                        <label for="p12File" class="file-input-label" id="p12FileLabel">
                            <i class="fas fa-file-upload"></i>
                            <span class="file-text" id="fileText">Hãy chọn file .p12 hoặc file .zip</span>
                            <span class="file-hint">Nhấp để chọn file</span>
                        </label>
                        <input type="file" id="p12File" class="file-input" accept=".p12,.P12,.zip,.ZIP">
                    </div>
                </div>

                <div class="form-group">
                    <label for="password">Mật khẩu</label>
                    <div class="password-container">
                        <input type="password" id="password" class="password-input" placeholder="Nhập mật khẩu chứng chỉ">
                        <button type="button" class="toggle-password" id="togglePassword">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <button id="checkButton" class="btn">Kiểm Tra Ngay</button>
                
                <div class="error-message" id="errorMessage"></div>
            </section>

            <div class="warning">
                <p><strong>⚠️ Lưu ý:</strong> Dịch vụ vẫn đang trong quá trình hoàn thiện nên đôi khi số liệu có thể chưa thật sự chính xác. Nếu có sai sót, mong bạn thông cảm và bỏ qua giúp mình nhé T ω T</p>
                <p style="margin-top: 8px;">Để theo dõi đơn hàng trên hệ thống chi tiết vui lòng truy cập: <a href="https://chungchip12.com/nhan-hang" class="link" target="_blank">https://chungchip12.com/nhan-hang</a></p>
            </div>
        </div>

        <!-- Giao diện loading -->
        <div id="loadingSection" style="display: none;">
            <header>
                <h1>Kiểm Tra Chứng Chỉ P12</h1>
                <p class="subtitle">Đang phân tích chứng chỉ của bạn</p>
            </header>

            <section class="loading-section">
                <div class="loading">
                    <div class="spinner"></div>
                    <h3>🔄 Đang phân tích chứng chỉ</h3>
                    <p>Vui lòng chờ trong giây lát...</p>
                </div>
                
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar">0%</div>
                </div>

                <div class="loading-steps">
                    <div class="loading-step active" id="step1">Đọc file</div>
                    <div class="loading-step" id="step2">Giải mã</div>
                    <div class="loading-step" id="step3">Phân tích</div>
                    <div class="loading-step" id="step4">Hoàn tất</div>
                </div>
            </section>
        </div>

        <!-- Giao diện kết quả -->
        <div id="resultSection" style="display: none;">
            <header>
                <h1>Kết Quả Kiểm Tra</h1>
                <p class="subtitle">Thông tin chứng chỉ của bạn</p>
            </header>

            <section class="result-section">
                <h2 class="result-title">📋 THÔNG TIN CHỨNG CHỈ</h2>
                
                <div class="cert-info">
                    <div class="info-label">Tên chứng chỉ:</div>
                    <div class="info-value" id="certName">-</div>
                </div>
                
                <div class="cert-info">
                    <div class="info-label">Ngày hết hạn:</div>
                    <div class="info-value" id="expiryDate">-</div>
                </div>
                
                <div class="cert-info">
                    <div class="info-label">Trạng thái:</div>
                    <div class="info-value" id="status">-</div>
                </div>
                
                <div class="cert-info">
                    <div class="info-label">Còn lại:</div>
                    <div class="info-value" id="daysLeft">-</div>
                </div>
                
                <div class="cert-info">
                    <div class="info-label">Loại:</div>
                    <div class="info-value" id="certType">-</div>
                </div>

                <button id="backButton" class="btn btn-back">← Quay lại kiểm tra</button>
            </section>

            <div class="warning">
                <p><strong>⚠️ Lưu ý:</strong> Dịch vụ vẫn đang trong quá trình hoàn thiện nên đôi khi số liệu có thể chưa thật sự chính xác. Nếu có sai sót, mong bạn thông cảm và bỏ qua giúp mình nhé T ω T</p>
                <p style="margin-top: 8px;">Để theo dõi đơn hàng trên hệ thống chi tiết vui lòng truy cập: <a href="https://chungchip12.com/nhan-hang" class="link" target="_blank">https://chungchip12.com/nhan-hang</a></p>
            </div>
        </div>
    </div>

    <footer>
        <p>© 2023 Kiểm Tra Chứng Chỉ P12. Tất cả quyền được bảo lưu.</p>
    </footer>

    <script>
        class CertificateAnalyzer {
            constructor() {
                this.supportedExtensions = ['.p12', '.zip'];
                this.progressCallback = null;
                this.currentStep = 0;
                this.steps = ['Đọc file', 'Giải mã', 'Phân tích', 'Hoàn tất'];
                this.stepProgress = [0, 25, 50, 75, 100];
                this.stepDurations = [800, 1200, 1500, 400];
                this.currentProgress = 0;
            }

            setProgressCallback(callback) {
                this.progressCallback = callback;
            }

            async updateProgress(stepIndex, stepProgress) {
                this.currentStep = stepIndex;
                const baseProgress = this.stepProgress[stepIndex];
                const nextProgress = this.stepProgress[stepIndex + 1];
                const progressInStep = (stepProgress / 100) * (nextProgress - baseProgress);
                this.currentProgress = baseProgress + progressInStep;
                
                if (this.progressCallback) {
                    this.progressCallback(this.currentProgress, this.steps[stepIndex]);
                }
            }

            async simulateStepProgress(stepIndex) {
                return new Promise((resolve) => {
                    let progress = 0;
                    const totalDuration = this.stepDurations[stepIndex];
                    const interval = 40;
                    const steps = totalDuration / interval;
                    const increment = 100 / steps;

                    const timer = setInterval(() => {
                        progress += increment;
                        if (progress >= 100) {
                            progress = 100;
                            clearInterval(timer);
                            this.updateProgress(stepIndex, progress);
                            resolve();
                        } else {
                            this.updateProgress(stepIndex, progress);
                        }
                    }, interval);
                });
            }

            // Hàm tạo mã ngẫu nhiên 6 ký tự
            generateRandomCode() {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let result = '';
                for (let i = 0; i < 6; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            }

            async analyzeP12(p12Data, password) {
                try {
                    await this.simulateStepProgress(0);
                    await this.simulateStepProgress(1);
                    
                    const p12Asn1 = forge.asn1.fromDer(forge.util.createBuffer(p12Data));
                    const p12 = forge.pkcs12.pkcs12FromAsn1(p12Asn1, password || '');
                    
                    const certBags = p12.getBags({ bagType: forge.pki.oids.certBag });
                    
                    if (!certBags[forge.pki.oids.certBag] || certBags[forge.pki.oids.certBag].length === 0) {
                        throw new Error('Không tìm thấy certificate trong file P12');
                    }

                    await this.simulateStepProgress(2);

                    const cert = certBags[forge.pki.oids.certBag][0].cert;
                    
                    if (!cert) {
                        throw new Error('Không thể đọc certificate');
                    }

                    const subject = cert.subject;
                    const certName = this.extractCommonName(subject);
                    
                    const notAfter = cert.validity.notAfter;
                    const notBefore = cert.validity.notBefore;
                    
                    const today = new Date();
                    const expiryDate = new Date(notAfter);
                    const startDate = new Date(notBefore);
                    
                    const daysRemaining = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                    
                    let status = "🔴 Đã hết hạn";
                    if (daysRemaining > 0) {
                        status = daysRemaining > 30 ? "🟢 Hoạt động" : "🟡 Sắp hết hạn";
                    }
                    
                    let certType = "Development";
                    if (certName.includes('Distribution') || certName.includes('iPhone Distribution')) {
                        certType = "Distribution";
                    }
                    
                    const hasAppGroup = this.checkAppGroupSupport(cert);
                    
                    await this.simulateStepProgress(3);

                    const info = {
                        name: certName,
                        startDate: startDate,
                        expiryDate: expiryDate,
                        status: status,
                        daysLeft: daysRemaining,
                        type: certType,
                        hasAppGroup: hasAppGroup,
                        serialNumber: cert.serialNumber
                    };
                    
                    return info;
                    
                } catch (error) {
                    console.error('Lỗi phân tích P12:', error);
                    
                    if (error.message.includes('Invalid password') || 
                        error.message.includes('PKCS12') ||
                        error.message.includes('password')) {
                        throw new Error('Invalid password or PKCS12 data');
                    }
                    
                    throw error;
                }
            }

            checkAppGroupSupport(certificate) {
                try {
                    const extensions = certificate.extensions;
                    
                    for (let i = 0; i < extensions.length; i++) {
                        const extension = extensions[i];
                        
                        if (extension.name === 'certificatePolicies') {
                            return true;
                        }
                        
                        if (extension.name === 'extKeyUsage') {
                            const usages = extension.value;
                            const appGroupOIDs = [
                                '1.2.840.113635.100.6.1.1',
                                '1.2.840.113635.100.6.1.2',
                            ];
                            
                            for (let j = 0; j < usages.length; j++) {
                                const usage = usages[j];
                                if (appGroupOIDs.includes(usage)) {
                                    return true;
                                }
                            }
                        }
                    }
                    
                    const certName = certificate.subject.attributes
                        .map(attr => attr.value)
                        .join(' ')
                        .toLowerCase();
                    
                    const appGroupKeywords = ['appgroup', 'app-group', 'group', 'containers', 'icloud'];
                    
                    if (appGroupKeywords.some(keyword => certName.includes(keyword))) {
                        return true;
                    }
                    
                    return false;
                    
                } catch (error) {
                    console.error('Lỗi kiểm tra App Group:', error);
                    return false;
                }
            }

            extractCommonName(subject) {
                const cnAttr = subject.attributes.find(attr => attr.name === 'commonName');
                return cnAttr ? cnAttr.value : 'Unknown Certificate';
            }

            async processFile(file, password) {
                const fileExt = '.' + file.name.split('.').pop().toLowerCase();
                
                if (fileExt === '.zip') {
                    return await this.processZipFile(file, password);
                } else {
                    const arrayBuffer = await this.readFileAsArrayBuffer(file);
                    return await this.analyzeP12(arrayBuffer, password);
                }
            }

            async processZipFile(file, password) {
                try {
                    const arrayBuffer = await this.readFileAsArrayBuffer(file);
                    const zip = await JSZip.loadAsync(arrayBuffer);
                    
                    // Tìm file P12 trong zip
                    let p12File = null;
                    for (const fileName in zip.files) {
                        if (fileName.toLowerCase().endsWith('.p12')) {
                            p12File = zip.files[fileName];
                            break;
                        }
                    }
                    
                    if (!p12File) {
                        throw new Error('Không tìm thấy file P12 trong file ZIP');
                    }
                    
                    const p12Data = await p12File.async('uint8array');
                    return await this.analyzeP12(p12Data, password);
                    
                } catch (error) {
                    console.error('Lỗi xử lý file ZIP:', error);
                    throw error;
                }
            }

            readFileAsArrayBuffer(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        resolve(e.target.result);
                    };
                    
                    reader.onerror = function() {
                        reject(new Error('Không thể đọc file'));
                    };
                    
                    reader.readAsArrayBuffer(file);
                });
            }

            // Hàm mã hóa an toàn cho Unicode
            safeBtoa(str) {
                return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
                    return String.fromCharCode('0x' + p1);
                }));
            }

            // Hàm giải mã an toàn cho Unicode
            safeAtob(str) {
                return decodeURIComponent(Array.prototype.map.call(atob(str), function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
            }
        }

        const analyzer = new CertificateAnalyzer();

        // Cập nhật giao diện khi chọn file
        document.getElementById('p12File').addEventListener('change', function() {
            const file = this.files[0];
            const fileLabel = document.getElementById('p12FileLabel');
            const fileText = document.getElementById('fileText');
            
            if (file) {
                fileText.textContent = file.name;
                fileLabel.classList.add('has-file');
            } else {
                fileText.textContent = 'Hãy chọn file .p12 hoặc file .zip';
                fileLabel.classList.remove('has-file');
            }
        });

        // Cập nhật giao diện khi nhập mật khẩu
        document.getElementById('password').addEventListener('input', function() {
            if (this.value.length > 0) {
                this.classList.add('has-value');
            } else {
                this.classList.remove('has-value');
            }
        });

        document.getElementById('togglePassword').addEventListener('click', function() {
            const passwordInput = document.getElementById('password');
            const icon = this.querySelector('i');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            
            if (type === 'password') {
                icon.className = 'fas fa-eye';
            } else {
                icon.className = 'fas fa-eye-slash';
            }
        });

        function showCheckSection() {
            document.getElementById('checkSection').style.display = 'block';
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('resultSection').style.display = 'none';
        }

        function showLoadingSection() {
            document.getElementById('checkSection').style.display = 'none';
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('resultSection').style.display = 'none';
        }

        function showResultSection() {
            document.getElementById('checkSection').style.display = 'none';
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('resultSection').style.display = 'block';
        }

        function updateProgressBar(percent, stepName) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percent + '%';
            progressBar.textContent = Math.round(percent) + '%';
            
            const steps = document.querySelectorAll('.loading-step');
            steps.forEach((step, index) => {
                if (index <= analyzer.currentStep) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });
        }

        document.getElementById('checkButton').addEventListener('click', async function() {
            const p12File = document.getElementById('p12File').files[0];
            const password = document.getElementById('password').value;

            if (!p12File || !password) {
                showError('Vui lòng chọn file P12 và nhập mật khẩu!');
                return;
            }

            const p12Ext = '.' + p12File.name.split('.').pop().toLowerCase();
            
            if (!analyzer.supportedExtensions.includes(p12Ext)) {
                showError('Định dạng file không được hỗ trợ. Vui lòng chọn file .p12 hoặc .zip');
                return;
            }

            hideError();
            document.getElementById('checkButton').disabled = true;

            try {
                showLoadingSection();
                analyzer.setProgressCallback(updateProgressBar);
                const certInfo = await analyzer.processFile(p12File, password);
                
                // Tạo mã ngẫu nhiên 6 ký tự
                const randomCode = analyzer.generateRandomCode();
                
                // Tạo URL mới với tham số order
                const newUrl = `${window.location.origin}${window.location.pathname}?order=${randomCode}`;
                
                // Thay đổi URL mà không reload trang
                window.history.pushState({}, '', newUrl);
                
                // Mã hóa và lưu dữ liệu vào localStorage
                const certData = {
                    n: certInfo.name,
                    e: certInfo.expiryDate.getTime(),
                    s: certInfo.status,
                    d: certInfo.daysLeft,
                    t: certInfo.type
                };
                
                const jsonString = JSON.stringify(certData);
                const encodedData = analyzer.safeBtoa(jsonString);
                localStorage.setItem(`cert_${randomCode}`, encodedData);
                
                console.log('🔗 URL chia sẻ:', newUrl);
                console.log('📋 Mã đơn:', randomCode);
                
                displayCertificateInfo(certInfo);
                showResultSection();
                
            } catch (error) {
                showCheckSection();
                let errorMessage = 'Lỗi khi xử lý chứng chỉ: ';
                
                if (error.message.includes('Invalid password or PKCS12 data')) {
                    errorMessage = '❌ Mật khẩu P12 sai.\nBạn vui lòng hãy nhập chính xác mật khẩu để hệ thống có thể phân tích được dữ liệu nhé!';
                } else if (error.message.includes('Không tìm thấy file P12 trong file ZIP')) {
                    errorMessage = '❌ Không tìm thấy file P12 trong file ZIP.\nVui lòng kiểm tra lại file ZIP của bạn.';
                } else {
                    errorMessage += error.message;
                }
                
                showError(errorMessage);
            } finally {
                document.getElementById('checkButton').disabled = false;
            }
        });

        function displayCertificateInfo(certInfo) {
            let typeText = certInfo.type;
            if (certInfo.hasAppGroup) {
                typeText += ' có hỗ trợ App Group';
            } else {
                typeText += ' không hỗ trợ App Group';
            }
            
            let statusClass = 'status-expired';
            if (certInfo.daysLeft > 30) {
                statusClass = 'status-active';
            } else if (certInfo.daysLeft > 0) {
                statusClass = 'status-warning';
            }
            
            document.getElementById('certName').textContent = certInfo.name;
            document.getElementById('expiryDate').textContent = formatDate(certInfo.expiryDate);
            document.getElementById('status').textContent = certInfo.status;
            document.getElementById('status').className = `info-value ${statusClass}`;
            document.getElementById('daysLeft').textContent = `${certInfo.daysLeft} ngày`;
            document.getElementById('certType').textContent = typeText;
        }

        document.getElementById('backButton').addEventListener('click', function() {
            // Quay về URL gốc không có tham số
            const baseUrl = `${window.location.origin}${window.location.pathname}`;
            window.history.pushState({}, '', baseUrl);
            
            showCheckSection();
            document.getElementById('p12File').value = '';
            document.getElementById('fileText').textContent = 'Hãy chọn file .p12 hoặc file .zip';
            document.getElementById('p12FileLabel').classList.remove('has-file');
            document.getElementById('password').value = '';
            document.getElementById('password').classList.remove('has-value');
            document.getElementById('password').setAttribute('type', 'password');
            document.getElementById('togglePassword').innerHTML = '<i class="fas fa-eye"></i>';
            hideError();
        });

        function formatDate(date) {
            return date.toLocaleDateString('vi-VN');
        }

        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        // Xử lý khi trang được load - kiểm tra xem có tham số order không
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const orderCode = urlParams.get('order');
            
            if (orderCode) {
                // Lấy dữ liệu từ localStorage
                const storedData = localStorage.getItem(`cert_${orderCode}`);
                
                if (storedData) {
                    try {
                        // Giải mã dữ liệu
                        const decodedString = analyzer.safeAtob(storedData);
                        const decodedData = JSON.parse(decodedString);
                        
                        const certInfo = {
                            name: decodedData.n,
                            expiryDate: new Date(decodedData.e),
                            status: decodedData.s,
                            daysLeft: decodedData.d,
                            type: decodedData.t,
                            hasAppGroup: decodedData.t.includes('có hỗ trợ App Group')
                        };
                        
                        displayCertificateInfo(certInfo);
                        showResultSection();
                    } catch (error) {
                        console.error('Lỗi khi giải mã dữ liệu:', error);
                    }
                }
            }
        });
    </script>
</body>
</html>
